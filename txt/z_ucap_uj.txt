z_ucap_uj1:--z_ucap_uj1
declare @t_bproduct nvarchar(20) = case when '#non'=[2] then '' else [2] end
declare @t_eproduct nvarchar(20) = case when '#non'=[3] then char(255) else [3] end
declare @t_groupdno nvarchar(20) = case when '#non'=[5] then '' else [5] end

declare @tmp table(
	gno nvarchar(1),
	rr int,
	noa nvarchar(50),
	product nvarchar(50),
	groupdno nvarchar(20),
	rev nvarchar(20),
	stationgno nvarchar(20),
	mechs nvarchar(20),
	trans nvarchar(20),
	unit nvarchar(20),
	molds nvarchar(50),
	pro1 nvarchar(50),
	pro2 nvarchar(50),
	pro3 nvarchar(50),
	engpro nvarchar(100),
	pro4 nvarchar(50),
	memo nvarchar(max)
)
insert @tmp
select '0','',a.noa,a.product,a.groupdno,a.rev,a.stationgno,a.mechs,a.trans,a.unit,a.molds,'','','',a.engpro,'',a.memo
from uca a
where a.typea='2'
and(a.noa between @t_bproduct and @t_eproduct)
and (len(@t_groupdno)=0 or a.groupdno=@t_groupdno)

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno order by noa)rx,rr from @tmp)a

update @tmp
set pro1=b.productno
from @tmp a left join ucas b on a.noa=b.noa
left join uca c on b.productno=c.noa
where c.typea='3'

update @tmp
set pro2=b.productno
from @tmp a left join ucas b on a.noa=b.noa
left join ucc c on b.productno=c.noa
where c.groupano='9P'

update @tmp
set pro3=b.productno
from @tmp a left join ucas b on a.noa=b.noa
left join ucc c on b.productno=c.noa
where c.groupano='9C'

update @tmp
set pro4=b.productno
from @tmp a left join ucas b on a.noa=b.noa
left join ucc c on b.productno=c.noa
where c.groupano='9B'

select * from @tmp
;